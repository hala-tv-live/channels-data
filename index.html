<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="screen-orientation" content="portrait">
  <meta name="apple-mobile-web-app-orientation" content="portrait">
  <title>هلا تي في</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <style>
    :root {
      --primary-color: #1e88e5;
      --accent-color: #e53935;
      --heart-off: #ffeb3b;
      --heart-on: #e53935;
      --light-color: #f5f5f5;
      --dark-color: #212121;
      --text-color: #333;
      --text-light: #fff;
      --shadow: 0 4px 6px rgba(0,0,0,0.1);
      --gradient-start: #e53935;
      --gradient-end: #1e88e5;
      --blue-btn: #1e88e5;
      --red-btn: #e53935;
      --search-bg: rgba(255, 255, 255, 0.95);
      --search-border: rgba(0, 0, 0, 0.1);
    }
    
    * {
      margin:0;
      padding:0;
      box-sizing:border-box;
      font-family:'Tajawal',sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, var(--light-color) 0%, #e0e0e0 100%);
      color: var(--text-color);
      direction: rtl;
      min-height: 100vh;
      padding-bottom: 20px;
      overflow-x: hidden;
    }
    
    #loadingOverlay {
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(255,255,255,0.9);
      display:flex;
      flex-direction: column;
      align-items:center;
      justify-content:center;
      z-index:200;
      font-size:1.2rem;
      color: var(--heart-on);
    }
    
    .spinner {
      font-size: 3rem;
      margin-bottom: 20px;
      animation: spin 1.5s linear infinite;
    }
    
    @keyframes spin {
      from { transform:rotate(0deg); }
      to { transform:rotate(360deg); }
    }
    
    .modal {
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.6);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:300;
    }
    
    .modal.hidden {
      display:none;
    }
    
    .modal-content {
      background:var(--light-color);
      padding:20px;
      border-radius:10px;
      text-align:center;
      box-shadow: var(--shadow);
      max-width:90%;
      width: 320px;
    }
    
    .modal-content h3 {
      color: var(--accent-color);
      margin-bottom: 15px;
      font-size: 1.4rem;
    }
    
    .modal-content p {
      margin-bottom:20px;
      font-size:1.1rem;
      color:var(--text-color);
      line-height: 1.6;
    }
    
    .modal-content .info-link {
      display: block;
      margin: 15px auto;
      padding: 8px 15px;
      background: var(--primary-color);
      color: white;
      border-radius: 5px;
      text-decoration: none;
      width: fit-content;
      transition: all 0.3s;
    }
    
    .modal-content .info-link:hover {
      background: #0d47a1;
      transform: translateY(-2px);
    }
    
    .modal-content button {
      margin:10px 6px 0;
      padding:8px 16px;
      border:none;
      border-radius:6px;
      font-size:1.1rem;
      cursor:pointer;
      transition: all 0.3s;
      font-weight: bold;
    }
    
    .btn-blue {
      background: var(--blue-btn);
      color:var(--text-light);
    }
    
    .btn-blue:hover {
      background: #0d47a1;
      transform: translateY(-2px);
    }
    
    .btn-red {
      background: var(--red-btn);
      color:var(--text-light);
    }
    
    .btn-red:hover {
      background: #c62828;
      transform: translateY(-2px);
    }
    
    header {
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:70px;
      background:var( --accent-color);
      color:var(--text-light);
      display:flex;
      align-items:center;
      padding:0 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index:90;
      transition: all 0.3s ease;
    }
    
    header.scrolled {
      height: 60px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    header h1 {
      flex-grow:1;
      text-align:center;
      font-size:1.6rem;
      letter-spacing: -0.5px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }
    
    header.scrolled h1 {
      font-size: 1.4rem;
    }
    
    #menuToggle, #searchBtn {
      background:none;
      border:none;
      color:var(--text-light);
      font-size:1.9rem;
      cursor:pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s;
    }
    
    #menuToggle:hover, #searchBtn:hover {
      background: rgba(255,255,255,0.2);
      transform: scale(1.05);
    }
    
    .search-container {
      position: relative;
      display: flex;
      align-items: center;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    #searchInput {
      width:0;
      padding:0;
      border:none;
      border-radius:30px;
      background: var(--search-bg);
      color: var(--text-color);
      transition: all .3s;
      opacity:0;
      font-size: 1rem;
      height: 40px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding-right: 40px;
      padding-left: 15px;
    }
    
    #searchInput::placeholder {
      color: #777;
      font-weight: normal;
    }
    
    #searchInput.active {
      width: 220px;
      padding: 0 35px 0 15px;
      opacity:1;
    }
    
    #searchInput:focus {
      outline: none;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
      background: white;
    }
    
    #clearSearch {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: red;
      border: none;
      color: #fff;
      font-size: 1rem;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.3s;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    
    #clearSearch.visible {
      opacity: 1;
    }
    
    #clearSearch:hover {
      background: rgba(0,0,0,0.05);
    }
    
    #sidebar {
      position:fixed;
      top:0;
      right:-300px;
      width:300px;
      height:100%;
      background: linear-gradient(180deg, var(--dark-color) 0%, #111 100%);
      color:var(--text-light);
      transition:right .4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      overflow-y:auto;
      z-index:100;
      box-shadow: -5px 0 15px rgba(0,0,0,0.3);
    }
    
    #sidebar.open {
      right:0;
    }
    
    .sidebar-header {
      padding:20px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:1px solid rgba(255,255,255,0.1);
      
      background: url('https://raw.githubusercontent.com/hala-tv-live/channels-data/refs/heads/main/colorful-splash-paint-with-splash-color_1236215-11813.jpg') center/cover;
            opacity: 3.1;
            z-index: -1;
    }
    
    .logo-container {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .logo-container img {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      background: linear-gradient(45deg, var(--gradient-start), var(--gradient-end));
    }
    
    .logo-text {
      font-size: 1.5rem;
      font-weight: bold;
      background: linear-gradient(45deg, #FFFFFF, #e0e0e0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    #closeSidebar {
      background:none;
      border:none;
      color:var(--text-light);
      font-size:1.8rem;
      cursor:pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.3s;
    }
    
    #closeSidebar:hover {
      background: rgba(255,255,255,0.1);
    }
    
    nav.categories a, .about-item {
      display:flex;
      align-items:center;
      padding:12px 20px;
      color:var(--text-light);
      text-decoration:none;
      transition:all .3s;
      font-size: 1.1rem;
      gap: 15px;
    }
    
    .about-link {
      display:flex;
      align-items:center;
      padding:12px 20px;
      color:var(--heart-off);
      text-decoration:none;
      transition:all .3s;
      font-size: 1.1rem;
      gap: 15px;
    }
    
    nav.categories a:hover, nav.categories a.active, 
    .about-item:hover, .about-link:hover {
      background:rgba(255,255,255,0.1);
      padding-right: 25px;
    }
    
    nav.categories a.active {
      border-right:4px solid var(--accent-color);
      background: rgba(229, 57, 53, 0.15);
    }
    
    nav.categories i, .about-item i, .about-link i {
      width: 24px;
      text-align: center;
    }
    
    .section-title {
      padding: 20px 20px 10px;
      font-size: 1.2rem;
      color: #bbb;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-top: 6px;
    }
    
    .about-links {
      display: none;
      padding: 0;
    }
    
    .about-links.expanded {
      display: block;
    }
    
    main {
      padding-top:80px;
      transition: padding-top 0.3s ease;
    }
    
    header.scrolled + main {
      padding-top: 70px;
    }
    
    .channels-grid {
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(170px,1fr));
      gap:20px;
      padding:20px;
      transition: all 0.3s ease;
    }
    
    .channel-card {
      position:relative;
      background:#fff;
      border-radius:6px;
      overflow:hidden;
      box-shadow: var(--shadow);
      transition:transform .2s,box-shadow .3s;
      cursor:pointer;
      border: 1px solid #eee;
      animation: fadeIn 0.5s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .channel-card:hover {
      transform:translateY(-8px);
      box-shadow:0 12px 25px rgba(0,0,0,0.2);
      border: 1px solid var(--accent-color);
    }
    
    .channel-img {
      width:100%;
      height:140px;
      object-fit:contain;
      padding:2px;
      background: #f9f9f9;
      transition: all 0.3s ease;
    }
    
    .channel-info {
      padding:5px 10px;
      text-align: center;
      background: linear-gradient(to bottom, #fff, #f5f5f5);
    }
    
    .channel-name {
      font-size:1rem;
      font-weight:bold;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      margin-bottom: 5px;
      color: #333;
    }
    
    .channel-category {
      font-size:.85rem;
      color:#Ffffff;
      background: #1e90ff;
      display: inline-block;
      padding: 3px 10px;
      border-radius: 20px;
    }
    
    .favorite-icon {
      position:absolute;
      top:10px;
      left:12px;
      font-size:1.2rem;
      cursor:pointer;
      background: rgba(255,255,255,0.8);
      width: 23px;
      height: 23px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      transition: all 0.3s;
      border: 0.4px solid black;
      border-radius: 50% 50%;
    }
    
    .favorite-icon:hover {
      transform: scale(1.15);
    }
    
    .favorite-icon.off {
      color: var(--heart-off);
    }
    
    .favorite-icon.on {
      color: var(--heart-on);
    }
    
    
    #videoPlayer {
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:#000;
      z-index:110;
      display:none;
    }
    
    #closePlayer {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(0,0,0,0.5);
      color: white;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 1rem;
      cursor: pointer;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      opacity: 0.7;
    }
    
    #closePlayer:hover {
      background: rgba(0,0,0,0.8);
      transform: scale(1.1);
      opacity: 1;
    }
    
    #player {
      width:100%;
      height:100%;
      object-fit:contain;
    }
    
    .plyr__controls {
      background:rgba(0,0,0,0.7);
    }
    
    .plyr__control {
      color:#fff;
    }
    
    .plyr__control:hover {
      color:var(--light-color)!important;
    }
    
    .no-results {
      grid-column: 1 / -1;
      text-align: center;
      padding: 40px 20px;
      font-size: 1.2rem;
      color: #666;
      animation: fadeIn 0.5s ease-out;
    }
    
    .no-results i {
      font-size: 3rem;
      margin-bottom: 20px;
      color: #ddd;
    }
    
    .app-footer {
      text-align: center;
      padding: 20px;
      color: #666;
      font-size: 0.9rem;
      margin-top: 20px;
    }
    
    .app-footer a {
      color: var(--primary-color);
      text-decoration: none;
    }
    
    .app-footer a:hover {
      text-decoration: underline;
    }
    
    @media (max-width: 768px) {
      .channels-grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 15px;
        padding: 15px;
      }
      
      header h1 {
        font-size: 1.3rem;
      }
      
      .channel-img {
        height: 120px;
      }
      
      #searchInput.active {
        width: 180px;
      }
    }
    
    @media (max-width: 480px) {
      .channels-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }
      
      #searchInput.active {
        width: 140px;
      }
      
      .channel-img {
        height: 100px;
      }
    }
    
    /* تحسينات لنافذة التوجيه */
    .player-guide {
      background: linear-gradient(135deg, #fff, #f9f9f9);
      color: #333;
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      max-width: 90%;
      width: 300px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    
    .player-guide h3 {
      font-size: 1.5rem;
      margin-bottom: 10px;
      color: #e53935;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .player-guide p {
      font-size: 1.1rem;
      line-height: 0.8;
      margin-bottom: 15px;
    }
    
    .player-guide .icon-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 25px 0;
    }
    
    .player-guide .icon {
      background: #1e88e5;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      color: white;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .player-guide .btn-blue {
      background: #1e88e5;
      color: #fff;
      font-weight: bold;
      padding: 10px 14px;
      font-size: 1.2rem;
      border-radius: 6px 4px;
      margin-top: 10px;
    }
    
    .player-guide .btn-blue:hover {
      transform: translateY(1px) scale(1.05);
      box-shadow: 0 6px 15px rgba(0,0,0,0.2);
    }
    
    .player-guide .btn-blue:active {
      transform: translateY(1px);
    }
    
    .instruction-arrow {
      display: block;
      font-size: 2.5rem;
      margin: 15px 0;
      color: #1e88e5;
      animation: bounce 1.5s infinite;
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    .remember-container {
      margin: 15px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .remember-container input {
      width: 18px;
      height: 18px;
    }
    
    
       /* نموذج الاتصال */
    .contact-form {
      width: 100%;
      max-width: 500px;
      padding: 20px;
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    
    .form-group {
      margin-bottom: 10px;
      text-align: right;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    
    .form-group input:focus,
    .form-group textarea:focus {
      border-color: var(--blue-btn);
      outline: none;
    }
    
    .form-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }
    
    .btn-form {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: bold;
    }
    
    .btn-send {
      background: var(--blue-btn);
      color: white;
    }
    
    .btn-cancel {
      background: var(--red-btn);
      color: white;
    }
    
    .btn-send:hover, .btn-cancel:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
    
    .contact-success {
      text-align: center;
      padding: 20px;
    }
    
    .contact-success i {
      font-size: 3rem;
      color: #4CAF50;
      margin-bottom: 15px;
    }
    
    .channel-stats {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
      font-size: 0.9rem;
      color: #666;
    }
    
    .stat-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .stat-item i {
      color: var(--accent-color);
    }
  </style>
</head>
<body>
  <div id="loadingOverlay">
    <div class="spinner"><i class="fas fa-spinner"></i></div>
    <div>جارٍ تحميل القنوات...</div>
  </div>
  
  <div id="modal" class="modal hidden">
    <div class="modal-content" id="modalContent"></div>
  </div>
  
  <!-- نافذة التوجيه مع خيار "لا تظهر مرة أخرى" -->
  <div id="playerGuideModal" class="modal hidden">
    <div class="player-guide">
      <h3>لتجربة مشاهدة أفضل</h3>
      <p>الرجاء اتباع الخطوات التالية:</p>
      
      <div class="icon-container">
        <div class="icon">
          <i class="fas fa-expand"></i>
        </div>
        <div class="instruction-arrow">
          <i class="fas fa-long-arrow-alt-right"></i>
        </div>
        <div class="icon">
          <i class="fas fa-mobile-alt"></i>
        </div>
      </div>
      
      <p>1. اضغط على زر ملء الشاشة</p>
      <p>2. قم بتدوير جهازك للوضع الأفقي</p>

      
      <div class="remember-container">
        <input type="checkbox" id="dontShowAgain">
        <label for="dontShowAgain">لا تظهر هذه الرسالة مرة أخرى</label>
      </div>
      
      <button id="guideConfirm" class="btn-blue">فهمت، شكراً</button>
    </div>
  </div>
  

  
  <div id="sidebar">
    <div class="sidebar-header">
      <div class="logo-container">
        <img src="https://raw.githubusercontent.com/hala-tv-live/channels-data/refs/heads/main/logo.png" alt="Logo">
        <div class="logo-text">هلا تي في</div>
      </div>
      <button id="closeSidebar"><i class="fas fa-times"></i></button>
    </div>
    
    <div class="section-title">التصنيفات</div>
    <nav class="categories"></nav>
    
    <a href="#" id="aboutApp" class="about-item">
      <i class="fas fa-info-circle"></i>
      <span>حول التطبيق</span>
      <i class="fas fa-chevron-down" style="margin-right: auto; font-size: 0.9rem;"></i>
    </a>
    <div class="about-links" id="aboutLinks">
      <a href="#" class="about-link" data-type="website">
        <i class="fas fa-globe"></i>
        <span>حول التطبيق</span>
      </a>
      <a href="#" class="about-link" data-type="privacy">
        <i class="fas fa-shield-alt"></i>
        <span>سياسة الخصوصية</span>
      </a>
      <a href="#" class="about-link" data-type="terms">
        <i class="fas fa-file-alt"></i>
        <span>سياسة الاستخدام</span>
      </a>
      <a href="#" class="about-link" data-type="contact">
        <i class="fas fa-envelope"></i>
        <span>اتصل بنا</span>
      </a>
    </div>
  </div>
  
  <main>
    <header id="mainHeader">
      <button id="menuToggle"><i class="fas fa-bars"></i></button>
      <h1>هلا تي في</h1>
      <div class="search-container">
        <input id="searchInput" placeholder="ابحث عن قناة...">
        <button id="searchBtn"><i class="fas fa-search"></i></button>
        <button id="clearSearch"><i class="fas fa-times"></i></button>
      </div>
    </header>
    
    <div class="channel-stats">
      <div class="stat-item">
        <i class="fas fa-tv"></i>
        <span id="totalChannels">0</span> قناة
      </div>
      <div class="stat-item">
        <i class="fas fa-star"></i>
        <span id="favoriteCount">0</span> مفضلة
      </div>
    </div>
    
    <div class="channels-grid" id="channelsContainer">
      <!-- القنوات ستظهر هنا -->
    </div>
    
    <div class="app-footer">
      تطبيق هلا تي في _جميع الحقوق محفوظه
    </div>
  </main>
  
  <div id="videoPlayer">
    <button id="closePlayer"><i class="fas fa-times"></i></button>
    <video id="player" playsinline controls></video>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
  
  <script>
    // دالة لعرض التنبيهات
    function showToast(msg, type = 'info', duration = 1000) {
      const bg = { 
        success: 'linear-gradient(to right, #1e90ff, #1e90ff)', 
        info: 'linear-gradient(to right, #3498db, #1e88e5)',
        warning: 'linear-gradient(to right, #000000, #000000)',
        error: 'linear-gradient(to right, #e53935, #c62828)'
      }[type];
      
      Toastify({ 
        text: msg, 
        duration, 
        gravity: 'bottom', 
        position: 'right',
        style: { 
          background: bg,
          borderRadius: '4px',
          boxShadow: '0 4px 12px rgba(0,0,0,0.15)'
        },
        className: "toast-" + type
      }).showToast();
    }
    
    // عناصر واجهة المستخدم
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContent');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.getElementById('sidebar');
    const closeSidebar = document.getElementById('closeSidebar');
    const searchBtn = document.getElementById('searchBtn');
    const searchInput = document.getElementById('searchInput');
    const clearSearch = document.getElementById('clearSearch');
    const channelsContainer = document.getElementById('channelsContainer');
    const categoriesNav = document.querySelector('.categories');
    const videoPlayer = document.getElementById('videoPlayer');
    const playerElem = document.getElementById('player');
    const aboutApp = document.getElementById('aboutApp');
    const aboutLinks = document.getElementById('aboutLinks');
    const closePlayerBtn = document.getElementById('closePlayer');
    const mainHeader = document.getElementById('mainHeader');
    const dontShowAgainCheckbox = document.getElementById('dontShowAgain');
    const totalChannelsElem = document.getElementById('totalChannels');
    const favoriteCountElem = document.getElementById('favoriteCount');
    
    // نافذة التوجيه
    const playerGuideModal = document.getElementById('playerGuideModal');
    const guideConfirm = document.getElementById('guideConfirm');
    
    // بيانات التطبيق
    let channels = [];
    let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
    let currentCategory = 'all';
    let hls;
    
    // تهيئة مشغل الفيديو
    const player = new Plyr(playerElem, { 
      controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'fullscreen'], 
      settings: ['quality', 'speed'],
      invertTime: false
    });
    
    // عنوان ملف القنوات
    const JSON_URL = 'https://raw.githubusercontent.com/hala-tv-live/channels-data/main/channels.json';
    
    // عند تحميل الصفحة
    window.addEventListener('DOMContentLoaded', () => {
      initListeners();
      loadChannels();
      setupScrollEffect();
      updateFavoriteCount();
    });
    
    // تحديث عدد القنوات المفضلة
    function updateFavoriteCount() {
      favoriteCountElem.textContent = favorites.length;
    }
    
    // إعداد تأثير التمرير لتصغير الهيدر
    function setupScrollEffect() {
      window.addEventListener('scroll', () => {
        if (window.scrollY > 20) {
          mainHeader.classList.add('scrolled');
        } else {
          mainHeader.classList.remove('scrolled');
        }
      });
    }
    
    // تهيئة المستمعين للأحداث
    function initListeners() {
      menuToggle.onclick = () => sidebar.classList.toggle('open');
      closeSidebar.onclick = () => sidebar.classList.remove('open');
      
      searchBtn.onclick = () => {
        searchInput.classList.toggle('active');
        if (searchInput.classList.contains('active')) {
          searchInput.focus();
        } else {
          clearSearchInput();
        }
      };
      
      searchInput.oninput = debounce(e => {
        renderChannels(filterByTerm(e.target.value));
        toggleClearButton(e.target.value);
      }, 300);
      
      clearSearch.onclick = () => {
        clearSearchInput();
      };
      
      categoriesNav.onclick = e => {
        const a = e.target.closest('a');
        if (a) {
          currentCategory = a.dataset.cat;
          updateCategories();
          renderChannels(filterByTerm(searchInput.value));
        }
      };
      
      window.addEventListener('popstate', () => {
        if (videoPlayer.style.display === 'block') closeVideo();
      });
      
      window.addEventListener('offline', () => showToast('❌ لا يوجد اتصال إنترنت!', 'error'));
      window.addEventListener('online', () => showToast('✅ تم استعادة الاتصال', 'success'));
      
      // أحداث قسم حول التطبيق
      aboutApp.onclick = () => {
        aboutLinks.classList.toggle('expanded');
      };
      
      // أحداث روابط حول التطبيق
      document.querySelectorAll('.about-link').forEach(link => {
        link.onclick = function(e) {
          e.preventDefault();
          const type = this.dataset.type;
          
          // معلومات لكل نوع من الروابط
          const info = {
            website: {
              title: "حول التطبيق",
              message: "هلا تي في تطبيق بث مباشر للقنوات:_تحكم أسهل_تشغيل أسرع_توفير أكثر..... رقم الإصدار: 1.0.",
              link: "https://halatv-live.blogspot.com/2025/06/hala-tv-live.html",
              icon: "fas fa-globe"
            },
            privacy: {
              title: "سياسة الخصوصية",
              message: "تعرف على كيفية تعاملنا مع بياناتك الشخصية وحماية خصوصيتك أثناء استخدامك للتطبيق.",
              link: "https://halatv-live.blogspot.com/p/privacy",
              icon: "fas fa-shield-alt"
            },
            terms: {
              title: "سياسة الاستخدام",
              message: "اقرأ الشروط والأحكام التي تحكم استخدامك للتطبيق وخدماتنا المختلفة.",
              link: "https://halatv-live.blogspot.com/p/terms",
              icon: "fas fa-file-alt"
            },
            contact: {
              title: "اتصل بنا",
              message: "لديك استفسار أو ملاحظة؟ لا تتردد في التواصل مع فريق الدعم الخاص بنا.",
              icon: "fas fa-envelope"
            }
          };
          
          // عرض النافذة المنبثقة بالمعلومات والرابط
          if (type === 'contact') {
            showContactForm();
          } else {
            showInfoModal(info[type]);
          }
        };
      });
      
      // مستمع حدث لزر الموافقة في نافذة التوجيه
      guideConfirm.onclick = () => {
        if (dontShowAgainCheckbox.checked) {
          localStorage.setItem('guideShown', 'true');
        }
        playerGuideModal.classList.add('hidden');
      };
      
      // مستمع لزر إغلاق مشغل الفيديو
      closePlayerBtn.onclick = closeVideo;
      
      // مستمع للضغط المزدوج على المشغل للدخول في وضع ملء الشاشة
      playerElem.addEventListener('dblclick', () => {
        if (player.fullscreen.active) {
          player.exitFullscreen();
        } else {
          player.enterFullscreen();
        }
      });
    }
    
    // دالة لتفادي التحميل المتكرر للبحث
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // تبديل حالة زر مسح البحث
    function toggleClearButton(value) {
      if (value) {
        clearSearch.classList.add('visible');
      } else {
        clearSearch.classList.remove('visible');
      }
    }
    
    // مسح حقل البحث
    function clearSearchInput() {
      searchInput.value = '';
      searchInput.classList.remove('active');
      clearSearch.classList.remove('visible');
      renderChannels(filterByCategory());
    }
    
    // دالة لإظهار نموذج الاتصال
    function showContactForm() {
      modalContent.innerHTML = `
        <h3>اتصل بنا</h3>
        <div class="contact-form">
          <form id="contactForm">
            <div class="form-group">
              <label for="name">الاسم:</label>
              <input type="text" id="name" name="name" required>
            </div>
            <div class="form-group">
              <label for="email">البريد الإلكتروني:</label>
              <input type="email" id="email" name="email" required>
            </div>
            <div class="form-group">
              <label for="message">الرسالة:</label>
              <textarea id="message" name="message" rows="4" required></textarea>
            </div>
            <div class="form-actions">
              <button type="button" id="cancelContact" class="btn-form btn-cancel">إلغاء</button>
              <button type="submit" class="btn-form btn-send">إرسال</button>
            </div>
          </form>
        </div>
      `;
      
      modal.classList.remove('hidden');
      
      // إضافة مستمع حدث جديد لزر الإلغاء
      document.getElementById('cancelContact').onclick = hideModal;
      
      // إضافة مستمع حدث لإرسال النموذج
      document.getElementById('contactForm').onsubmit = sendContactForm;
      
      // إدارة زر الرجوع في الهاتف
      history.pushState({ modalOpen: true }, '');
      window.addEventListener('popstate', handleBackButton);
    }
    
    // دالة لإرسال نموذج الاتصال
    function sendContactForm(e) {
      e.preventDefault();
      
      // في بيئة حقيقية، سيكون هنا كود إرسال البريد الإلكتروني
      // باستخدام خدمة مثل Formspree أو EmailJS
      
      // في هذا المثال سنعرض رسالة نجاح فقط
      modalContent.innerHTML = `
        <div class="contact-success">
          <i class="fas fa-check-circle"></i>
          <h3>تم إرسال رسالتك بنجاح</h3>
          <p>شكراً لتواصلك معنا، سنقوم بالرد عليك في أقرب وقت.</p>
          <button id="closeSuccess" class="btn-blue">إغلاق</button>
        </div>
      `;
      
      document.getElementById('closeSuccess').onclick = hideModal;
    }
    
    // دالة للتعامل مع زر الرجوع في الهاتف
    function handleBackButton() {
      if (modal.classList.contains('hidden') === false) {
        hideModal();
      }
    }
    
    // دالة لإظهار النافذة المنبثقة بالمعلومات والرابط
    function showInfoModal(info) {
      modalContent.innerHTML = `
        <h3>${info.title}</h3>
        <p>${info.message}</p>
        <a href="${info.link}" target="_blank" class="info-link">
          <i class="${info.icon}"></i> اضغط هنا للانتقال
        </a>
        <button id="infoClose" class="btn-blue" style="margin-top: 10px;">إغلاق</button>
      `;
      
      modal.classList.remove('hidden');
      
      // إضافة مستمع حدث جديد لزر الإغلاق
      document.getElementById('infoClose').onclick = hideModal;
    }
    
    // دالة لإظهار النافذة المنبثقة العامة (لأخطاء التحميل)
    function showErrorModal(message, showRetry = false) {
      modalContent.innerHTML = `
        <p>${message}</p>
        <div>
          ${showRetry ? '<button id="modalRetry" class="btn-red">إعادة المحاولة</button>' : ''}
          <button id="modalConfirm" class="btn-blue">موافق</button>
        </div>
      `;
      
      modal.classList.remove('hidden');
      
      // إضافة مستمعات الأحداث للأزرار
      document.getElementById('modalConfirm').onclick = hideModal;
      if (showRetry) {
        document.getElementById('modalRetry').onclick = () => {
          hideModal();
          loadChannels();
        };
      }
    }
    
    // دالة لإخفاء النافذة المنبثقة
    function hideModal() {
      modal.classList.add('hidden');
      window.removeEventListener('popstate', handleBackButton);
    }
    
    // تحميل القنوات من الملف
    async function loadChannels() {
      loadingOverlay.style.display = 'flex';
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 20000);
        
        const res = await fetch(JSON_URL, { signal: controller.signal });
        clearTimeout(timeoutId);
        
        // التحقق من نجاح الاستجابة
        if (!res.ok) throw new Error('فشل في جلب البيانات');
        
        // التحقق من صحة JSON
        const data = await res.text();
        channels = JSON.parse(data);
        channels.forEach((c, i) => c.id = i);
        
        // تحديث عدد القنوات
        totalChannelsElem.textContent = channels.length;
        
        // تم تحميل القنوات بنجاح
        updateCategories();
        renderChannels(channels);
        showToast('✅ تم تحميل القنوات بنجاح', 'success');
      } catch (error) {
        console.error('حدث خطأ أثناء تحميل القنوات:', error);
        
        // عرض الرسالة فقط إذا لم يتم تحميل أي قنوات
        if (channels.length === 0) {
          showErrorModal('⚠️ تعذر تحميل القنوات! الرجاء إعادة المحاولة', true);
        } else {
          // إذا كانت هناك قنوات محملة مسبقاً، فقط أظهر تنبيه
          showToast('⚠️ حدث خطأ أثناء تحديث القنوات، جارٍ استخدام البيانات المحفوظة', 'warning');
        }
      } finally {
        loadingOverlay.style.display = 'none';
      }
    }
    
    // تحديث قائمة التصنيفات مع أيقونات مناسبة لكل فئة
    function updateCategories() {
      const cats = ['all', ...new Set(channels.map(c => c.category)), 'favorites'];
      categoriesNav.innerHTML = cats.map(cat => {
        let icon = 'fas fa-tv';
        let label = cat;
        
        if (cat === 'all') {
          icon = 'fas fa-home';
          label = 'الرئيسية';
        } else if (cat === 'favorites') {
          icon = 'fas fa-star';
          label = 'المفضلة';
        } else {
          // تخصيص أيقونات للفئات الشائعة
          switch (cat.toLowerCase()) {
            case 'رياضية':
            case 'رياضة':
              icon = 'fas fa-futbol';
              break;
            case 'أخبار':
              icon = 'fas fa-newspaper';
              break;
            case 'ترفيه':
              icon = 'fas fa-film';
              break;
            case 'أطفال':
              icon = 'fas fa-child';
              break;
            case 'وثائقية':
              icon = 'fas fa-globe';
              break;
            case 'دينية':
              icon = 'fas fa-mosque';
              break;
            case 'تعليمية':
              icon = 'fas fa-graduation-cap';
              break;
            case 'موسيقى':
              icon = 'fas fa-music';
              break;
            case 'سياسة':
              icon = 'fas fa-landmark';
              break;
            case 'اقتصاد':
              icon = 'fas fa-chart-line';
              break;
            case 'أفلام':
              icon = 'fas fa-video';
              break;
            case 'مسلسلات':
              icon = 'fas fa-tv';
              break;
            case 'برامج':
              icon = 'fas fa-microphone-alt';
              break;
          }
        }
        
        return `
          <a href='#' data-cat='${cat}' class='${cat === currentCategory ? 'active' : ''}'>
            <i class='${icon}'></i>
            <span>${label}</span>
          </a>
        `;
      }).join('');
    }
    
    // عرض القنوات
    function renderChannels(list) {
      channelsContainer.innerHTML = '';
      
      if (!list.length) {
        channelsContainer.innerHTML = `
          <div class="no-results">
            <i class="fas fa-tv"></i>
            <div>لا توجد قنوات لعرضها</div>
          </div>
        `;
        return;
      }
      
      list.forEach(ch => {
        if ((currentCategory === 'favorites' && !favorites.includes(ch.id)) || 
            (currentCategory !== 'all' && currentCategory !== 'favorites' && ch.category !== currentCategory)) {
          return;
        }
        
        const isFav = favorites.includes(ch.id);
        const card = document.createElement('div');
        card.className = 'channel-card';
        
        // إنشاء رابط صورة احتياطي في حالة وجود مشكلة
        const fallbackSVG = (name) => 
          `data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"><rect fill="#f5f5f5" width="200" height="200"/><text fill="#666" font-family="Arial" font-size="18" x="100" y="100" text-anchor="middle" dominant-baseline="middle">${encodeURIComponent(name)}</text></svg>`;
        
        const imgSrc = ch.logo && ch.logo.trim() !== '' ? ch.logo : fallbackSVG(ch.name);
        
        card.innerHTML = `
          <i class='fas fa-heart favorite-icon ${isFav ? 'on' : 'off'}' data-id='${ch.id}'></i>
          <img class='channel-img' src='${imgSrc}' alt='${ch.name}'>
          <div class='channel-info'>
            <div class='channel-name'>${ch.name}</div>
            <div class='channel-category'>${ch.category}</div>
          </div>
        `;
        
        const favIcon = card.querySelector('.favorite-icon');
        favIcon.onclick = e => {
          e.stopPropagation();
          toggleFav(ch.id, ch.name);
          renderChannels(filterByCategory());
        };
        
        card.onclick = () => openPlayer(ch.stream_url, ch.name);
        channelsContainer.appendChild(card);
      });
    }
    
    // فلترة القنوات حسب التصنيف
    function filterByCategory() {
      if (currentCategory === 'all') return channels;
      if (currentCategory === 'favorites') return channels.filter(c => favorites.includes(c.id));
      return channels.filter(c => c.category === currentCategory);
    }
    
    // فلترة القنوات حسب البحث
    function filterByTerm(term) {
      return filterByCategory().filter(c => 
        c.name.toLowerCase().includes(term.toLowerCase()) || 
        c.category.toLowerCase().includes(term.toLowerCase())
      );
    }
    
    // إضافة/حذف من المفضلة
    function toggleFav(id, name) {
      const idx = favorites.indexOf(id);
      
      if (idx > -1) {
        favorites.splice(idx, 1);
        showToast(`تم حذف قناة “${name}” من المفضلة`, 'warning');
      } else {
        favorites.push(id);
        showToast(`تم إضافة قناة “${name}” إلى المفضلة`, 'success');
      }
      
      localStorage.setItem('favorites', JSON.stringify(favorites));
      updateFavoriteCount();
    }
    
    // فتح مشغل الفيديو
    function openPlayer(url, name) {
      document.title = `هلا تي في - ${name}`;
      videoPlayer.style.display = 'block';
      history.pushState({ playerOpen: true }, '');
      
      // إظهار نافذة التوجيه فقط إذا لم تظهر من قبل
      if (!localStorage.getItem('guideShown')) {
        playerGuideModal.classList.remove('hidden');
      }
      
      // تدمير أي مثيل سابق لـ HLS
      if (hls) {
        hls.destroy();
        hls = null;
      }
      
      // التحقق من دعم HLS قبل استخدامه
      if (typeof Hls !== 'undefined' && Hls.isSupported()) {
        hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(playerElem);
        
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          player.play();
          showToast(`جارٍ تشغيل: ${name}`, 'info');
        });
        
        hls.on(Hls.Events.ERROR, (e, data) => {
          if (data.fatal) {
            if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
              showToast('⚠️ مشكلة بالشبكة أثناء التشغيل', 'warning');
            } else if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
              hls.recoverMediaError();
            }
          }
        });
      } else if (playerElem.canPlayType('application/vnd.apple.mpegurl')) {
        playerElem.src = url;
        player.play();
        showToast(`جارٍ تشغيل: ${name}`, 'info');
      } else {
        showToast('⚠️ المتصفح لا يدعم تشغيل هذا النوع من الفيديو', 'error');
      }
    }
    
    // إغلاق مشغل الفيديو
    function closeVideo() {
      document.title = 'هلا تي في';
      videoPlayer.style.display = 'none';
      player.pause();
      
      // تدمير مثيل HLS وتحرير الذاكرة
      if (hls) {
        hls.destroy();
        hls = null;
      }
      
      // إعادة تعيين مصدر الفيديو
      playerElem.src = '';
      playerElem.load();
      
      if (history.state && history.state.playerOpen) {
        history.back();
      }
    }
  </script>
</body>
</html>
